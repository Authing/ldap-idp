{"version":3,"file":"ldap-idp.cjs.development.js","sources":["../src/index.ts"],"sourcesContent":["const ldap = require('ldapjs');\nconst MongoClient = require('mongodb').MongoClient;\nconst ldapdb = require('./ldapdb.json');\n\nconst assert = require('assert');\n\n// Connection URL\nconst url = [\n  'mongodb://',\n  ldapdb.user + ':' + ldapdb.password + '@',\n  ldapdb.ip,\n  ':',\n  ldapdb.port,\n  '/',\n  ldapdb.dbname,\n].join('');\n\n// Use connect method to connect to the server\nMongoClient.connect(url, function(_err: any, client: any) {\n  assert.equal(null, _err);\n  console.log(\"Connected successfully to server\");\n\n  // const insertDocuments = function(db, callback) {\n  //   // Get the documents collection\n  //   const collection = db.collection('documents');\n  //   // Insert some documents\n  //   collection.insertMany([\n  //     {a : 1}, {a : 2}, {a : 3}\n  //   ], function(err, result) {\n  //     assert.equal(err, null);\n  //     assert.equal(3, result.result.n);\n  //     assert.equal(3, result.ops.length);\n  //     console.log(\"Inserted 3 documents into the collection\");\n  //     callback(result);\n  //   });\n  // }\n\n  const findDocuments = function(db: any, callback: any) {\n    const collection = db.collection('users');\n    collection.find({}).toArray(function(err: any, docs: any) {\n      assert.equal(err, null);\n      callback(docs);\n    });\n  }  \n\n  const db = client.db(ldapdb.dbname);\n  \n  findDocuments(db, (users: any) => {\n    console.log(users);\n  });\n\n  client.close();\n});\n\n///--- Shared handlers\n\nfunction authorize(req: { connection: { ldap: { bindDN: { equals: (arg0: string) => string; }; }; }; }, _res: any, next: { (arg0: any): void; (): void; }) {\n  /* Any user may search after bind, only cn=root has full power */\n  var isSearch = (req instanceof ldap.SearchRequest);\n  if (!req.connection.ldap.bindDN.equals('cn=root') && !isSearch)\n    return next(new ldap.InsufficientAccessRightsError());\n\n  return next();\n}\n\n///--- Globals\n\nvar SUFFIX: string = 'o=joyent';\nvar db: any = {};\nvar server: any = ldap.createServer();\n\nserver.bind('cn=root', function(req: any, res: any, next: any) {\n  if (req.dn.toString() !== 'cn=root' || req.credentials !== 'secret')\n    return next(new ldap.InvalidCredentialsError());\n\n  res.end();\n  return next();\n});\n\nserver.add(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; toObject: () => { attributes: any; }; }, res: { end: () => void; }, next: { (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n\n  if (db[dn])\n    return next(new ldap.EntryAlreadyExistsError(dn));\n\n  db[dn] = req.toObject().attributes;\n  res.end();\n  return next();\n});\n\nserver.bind(SUFFIX, function(req: { dn: { toString: () => string; }; credentials: any; }, res: { end: () => void; }, next: { (arg0: any): void; (arg0: any): void; (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  if (!db[dn].userpassword)\n    return next(new ldap.NoSuchAttributeError('userPassword'));\n\n  if (db[dn].userpassword.indexOf(req.credentials) === -1)\n    return next(new ldap.InvalidCredentialsError());\n\n  res.end();\n  return next();\n});\n\nserver.compare(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; attribute: string | number; value: any; }, res: { end: (arg0: boolean) => void; }, next: { (arg0: any): void; (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  if (!db[dn][req.attribute])\n    return next(new ldap.NoSuchAttributeError(req.attribute));\n\n  var matches = false;\n  var vals = db[dn][req.attribute];\n  for (var i = 0; i < vals.length; i++) {\n    if (vals[i] === req.value) {\n      matches = true;\n      break;\n    }\n  }\n\n  res.end(matches);\n  return next();\n});\n\nserver.del(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; }, res: { end: () => void; }, next: { (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  delete db[dn];\n\n  res.end();\n  return next();\n});\n\nserver.modify(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; changes: { operation: any, modification: any; }[]; }, res: { end: () => void; }, next: { (arg0: any): void; (arg0: any): void; (arg0: any): void; (arg0: any): void; (): void; }) {\n  const dn = req.dn.toString();\n  let mod: any = null;\n  if (!req.changes.length)\n    return next(new ldap.ProtocolError('changes required'));\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  var entry = db[dn];\n\n  for (var i = 0; i < req.changes.length; i++) {\n    mod = req.changes[i].modification;\n    switch (req.changes[i].operation) {\n    case 'replace':\n      if (!entry[mod.type])\n        return next(new ldap.NoSuchAttributeError(mod.type));\n\n      if (!mod.vals || !mod.vals.length) {\n        delete entry[mod.type];\n      } else {\n        entry[mod.type] = mod.vals;\n      }\n\n      break;\n\n    case 'add':\n      if (!entry[mod.type]) {\n        entry[mod.type] = mod.vals;\n      } else {\n        mod.vals.forEach(function(v: any) {\n          if (entry[mod.type].indexOf(v) === -1)\n            entry[mod.type].push(v);\n        });\n      }\n\n      break;\n\n    case 'delete':\n      if (!entry[mod.type])\n        return next(new ldap.NoSuchAttributeError(mod.type));\n\n      delete entry[mod.type];\n\n      break;\n    }\n  }\n\n  res.end();\n  return next();\n});\n\nserver.search(SUFFIX, authorize, function(req: { dn: { toString: () => string; equals: { (arg0: any): boolean; (arg0: any): boolean; }; parentOf: (arg0: any) => void; }; scope: any; filter: { matches: { (arg0: any): boolean; (arg0: any): boolean; }; }; }, res: { send: { (arg0: { dn: any; attributes: any; }): void; (arg0: { dn: string; attributes: any; }): void; }; end: { (): void; (): void; }; }, next: { (arg0: any): void; (): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  var scopeCheck: { (k: any): any; (k: any): any; (arg0: string): void; };\n\n  switch (req.scope) {\n  case 'base':\n    if (req.filter.matches(db[dn])) {\n      res.send({\n        dn: dn,\n        attributes: db[dn]\n      });\n    }\n\n    res.end();\n    return next();\n\n  case 'one':\n    scopeCheck = function(k: any) {\n      if (req.dn.equals(k))\n        return true;\n\n      var parent = ldap.parseDN(k).parent();\n      return (parent ? parent.equals(req.dn) : false);\n    };\n    break;\n\n  case 'sub':\n    scopeCheck = function(k: any) {\n      return (req.dn.equals(k) || req.dn.parentOf(k));\n    };\n\n    break;\n  }\n\n  Object.keys(db).forEach(function(key) {\n    if (!scopeCheck(key))\n      return;\n\n    if (req.filter.matches(db[key])) {\n      res.send({\n        dn: key,\n        attributes: db[key]\n      });\n    }\n  });\n\n  res.end();\n  return next();\n});\n\n///--- Fire it up\n\nserver.listen(1389, function() {\n  console.log('LDAP server up at: %s', server.url);\n});"],"names":["ldap","require","MongoClient","ldapdb","assert","url","user","password","ip","port","dbname","join","connect","_err","client","equal","console","log","findDocuments","db","callback","collection","find","toArray","err","docs","users","close","authorize","req","_res","next","isSearch","SearchRequest","connection","bindDN","equals","InsufficientAccessRightsError","SUFFIX","server","createServer","bind","res","dn","toString","credentials","InvalidCredentialsError","end","add","EntryAlreadyExistsError","toObject","attributes","NoSuchObjectError","userpassword","NoSuchAttributeError","indexOf","compare","attribute","matches","vals","i","length","value","del","modify","mod","changes","ProtocolError","entry","modification","operation","type","forEach","v","push","search","scopeCheck","scope","filter","send","k","parent","parseDN","parentOf","Object","keys","key","listen"],"mappings":"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"}