{"version":3,"file":"ldap-idp.cjs.development.js","sources":["../src/config.ts","../src/index.ts"],"sourcesContent":["export default {\n  domainComponent: ['authing', 'cn'],\n  authing: {\n    graphqlEndPoint: {\n      core: 'https://core.authing.cn/graphql',\n    },\n    passwordEncPublicKey: `-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC4xKeUgQ+Aoz7TLfAfs9+paePb\n5KIofVthEopwrXFkp8OCeocaTHt9ICjTT2QeJh6cZaDaArfZ873GPUn00eOIZ7Ae\n+TiA2BKHbCvloW3w5Lnqm70iSsUi5Fmu9/2+68GZRH9L7Mlh8cFksCicW2Y2W2uM\nGKl64GDcIq3au+aqJQIDAQAB\n-----END PUBLIC KEY-----`,\n  },\n};\n","const ldap = require('ldapjs');\n// const parseDN = require('ldapjs').parseDN;\n// const fs = require('fs');\nconst MongoClient = require('mongodb').MongoClient;\nconst ObjectId = require('mongodb').ObjectId;\nconst ldapdb = require('./ldapdb.json');\nimport config from './config';\n\nconst assert = require('assert');\n\nconst Authing = require('authing-js-sdk');\n\n// Connection URL\nconst url = `mongodb://${ldapdb.user}:${ldapdb.password}@${\n  ldapdb.replicaSet.addr\n}/${ldapdb.dbname}?readPreference=secondaryPreferred&replicaSet=${\n  ldapdb.replicaSet.name\n}`;\n\nprocess.on('unhandledRejection', err => {\n  console.log('全局reject');\n  console.log(err);\n});\nfunction generateDc(domainComponent: Array<string>, seperator: string = ',') {\n  let arr = domainComponent.map(item => 'dc=' + item);\n  let dcStr = arr.join(seperator);\n  return dcStr;\n}\n// uncaughtException 避免程序崩溃\nprocess.on('uncaughtException', function(err) {\n  console.log(err);\n});\n\n// Use connect method to connect to the server\nMongoClient.connect(url, function(_err: any, client: any) {\n  assert.equal(null, _err);\n\n  console.log('Connected successfully to server');\n\n  const db = client.db(ldapdb.dbname);\n  createLDAPServer(db);\n  // client.close();\n});\n\nconst createLDAPServer = (db: any) => {\n  const server: any = ldap.createServer();\n\n  const findUsers: any = function(opts: any) {\n    return new Promise((resolve: any, reject: any) => {\n      const collection = db.collection('users');\n      opts['isDeleted'] = false;\n      collection.find(opts).toArray(function(err: any, docs: any) {\n        if (err) reject(err);\n        resolve(docs);\n      });\n    });\n  };\n\n  const findClients: any = function(callback: any) {\n    const clients = db.collection('userpools');\n    clients\n      .find({\n        isDeleted: false,\n      })\n      .toArray(function(err: any, docs: any) {\n        assert.equal(err, null);\n        callback(docs);\n      });\n  };\n\n  const removeUser: any = function(query: any) {\n    return new Promise((_resolve: any, _reject: any) => {\n      const collection = db.collection('users');\n      query['isDeleted'] = false;\n      collection.updateOne(query, {\n        $set: {\n          isDeleted: true,\n        },\n      });\n      findUsers(query)\n        .then((users: any) => {\n          _resolve(users);\n        })\n        .catch((err: any) => {\n          _reject(err);\n        });\n    });\n  };\n\n  // const updateUser: any = function(query: any, set: any) {\n  //   return new Promise((_resolve: any, _reject: any) => {\n  //     const collection = db.collection('users');\n  //     query['isDeleted'] = false;\n  //     collection.updateOne(query, set);\n  //     findUsers(query)\n  //       .then((users: any) => {\n  //         _resolve(users);\n  //       })\n  //       .catch((err: any) => {\n  //         _reject(err);\n  //       });\n  //   });\n  // };\n\n  const initLdapRoutes: any = function(client: any) {\n    let bindDN: string = `ou=users,o=${client._id},${generateDc(\n      config.domainComponent\n    )}`;\n    const SUFFIX: string = `ou=users, o=${client._id}, ${generateDc(\n      config.domainComponent,\n      ', '\n    )}`;\n\n    /*\n      DN = uid=LDAP_BINDING_USER（邮箱或者手机号）,ou=Users,o=AUTHING_CLINET_ID,dc=authing,dc=cn\n      ldapsearch -H ldap://localhost:1389 -x -D \"ou=users,o=59f86b4832eb28071bdd9214,dc=authing,dc=cn\" -LLL -b \"ou=users,o=59f86b4832eb28071bdd9214,dc=authing,dc=cn\" cn=18000179176\n    */\n\n    server.bind(bindDN, async function(_req: any, res: any, next: any) {\n      const o: any = _req.dn.rdns[1].attrs;\n      let currentClientId: any = '';\n      if (o['o']) {\n        currentClientId = o.o.value;\n      } else {\n        const rdns: any = _req.dn.rdns;\n        for (let i = 0; i < rdns.length; i++) {\n          const rdn = rdns[i];\n          for (let key in rdn.attrs) {\n            if (key === 'o') {\n              currentClientId = rdn.attrs.o.value;\n            }\n          }\n        }\n      }\n\n      console.log(_req.dn.rdns.toString());\n\n      const dnString = _req.dn.rdns.toString();\n\n      /*\n        需要分两种类型进行验证\n        1. 只用 client 进行查询，使用 secret 进行验证\n        2. 对单个用户进行查询，使用用户真实密码进行验证\n      */\n\n      if (dnString.indexOf('uid=') > -1) {\n        try {\n          const rdns: any = _req.dn.rdns;\n          let uid: string = '';\n          for (let i = 0; i < rdns.length; i++) {\n            const rdn = rdns[i];\n            for (let key in rdn.attrs) {\n              if (key === 'uid') {\n                uid = rdn.attrs.uid.value;\n              }\n            }\n          }\n\n          const users: any = await findUsers({\n            registerInClient: ObjectId(currentClientId),\n            _id: ObjectId(uid),\n          });\n\n          const user: any = users[0];\n\n          if (user.password) {\n            if (currentClientId.toString() === client._id.toString()) {\n              const authing = new Authing({\n                userPoolId: currentClientId,\n                secret: client.secret,\n                host: {\n                  user: config.authing.graphqlEndPoint.core,\n                  oauth: config.authing.graphqlEndPoint.core,\n                },\n                passwordEncPublicKey: config.authing.passwordEncPublicKey,\n              });\n\n              const loginOpt = {\n                username: user.username,\n                password: _req.credentials,\n              };\n              await authing.login(loginOpt);\n            }\n          }\n        } catch (error) {\n          return next(new ldap.InvalidCredentialsError(JSON.stringify(error)));\n        }\n      } else {\n        if (\n          !(\n            currentClientId.toString() === client._id.toString() &&\n            _req.credentials.toString() === client.secret.toString()\n          )\n        ) {\n          return next(new ldap.InvalidCredentialsError());\n        }\n      }\n\n      res.end();\n      return next();\n    });\n\n    const authorize = (_req: any, _res: any, next: any) => {\n      if (!_req.connection.ldap.bindDN.equals(bindDN))\n        return next(new ldap.InsufficientAccessRightsError());\n      return next();\n    };\n\n    const loadCurrentClientId = (req: any, _res: any, next: any) => {\n      req.currentClientId = '';\n      const rdns: any = req.dn.rdns;\n      for (let i = 0; i < rdns.length; i++) {\n        const rdn = rdns[i];\n        for (let key in rdn.attrs) {\n          if (key === 'o') {\n            req.currentClientId = rdn.attrs.o.value;\n          }\n        }\n      }\n      return next();\n    };\n\n    const pre: any = [authorize, loadCurrentClientId];\n\n    server.search(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapsearch -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" -LLL -b \"ou=users,o=59f86b4832eb28071bdd9214,dc=authing,dc=cn\" cn=ldap-tester\n\n      const filterKey: any = req.filter.attribute;\n      const filterValue: any = req.filter.value || '*';\n\n      // const queryDN = req.dn.toString();\n\n      const filterKeyMapping: any = {\n        cn: 'username',\n        gid: '_id',\n        uid: '_id',\n      };\n\n      let queryOptions: any = {\n        registerInClient: ObjectId(req.currentClientId),\n      };\n\n      let users: any;\n      req.users = {};\n\n      if (filterKeyMapping[filterKey]) {\n        const key: any = filterKeyMapping[filterKey];\n        queryOptions[key] = key === '_id' ? ObjectId(filterValue) : filterValue;\n        users = await findUsers(queryOptions);\n\n        const currentUser: any = users[0];\n        const cn: any = currentUser.username;\n        const dn: string = `cn=${cn},uid=${currentUser._id}, ou=users, o=${\n          req.currentClientId\n        }, ${generateDc(config.domainComponent, ', ')}`;\n        currentUser['cn'] = cn;\n        currentUser['gid'] = currentUser._id;\n        currentUser['uid'] = currentUser._id;\n        currentUser['objectclass'] = 'users';\n\n        delete currentUser['__v'];\n        delete currentUser['isDeleted'];\n        delete currentUser['salt'];\n\n        res.send({\n          dn,\n          attributes: currentUser,\n        });\n      } else {\n        users = await findUsers(queryOptions);\n        for (var i = 0; i < users.length; i++) {\n          const currentUser: any = users[i];\n          const cn: any = currentUser.username;\n          const dn: string = `cn=${cn},uid=${currentUser._id}, ou=users, o=${\n            req.currentClientId\n          }, ${generateDc(config.domainComponent, ', ')}`;\n          currentUser['cn'] = cn;\n          currentUser['gid'] = currentUser._id;\n          currentUser['uid'] = currentUser._id;\n          currentUser['objectclass'] = 'users';\n          delete currentUser['__v'];\n          delete currentUser['isDeleted'];\n          delete currentUser['salt'];\n\n          req.users[dn] = {\n            dn,\n            attributes: currentUser,\n          };\n\n          Object.keys(req.users).forEach(function(key) {\n            if (req.filter.matches(req.users[key].attributes)) {\n              res.send(req.users[key]);\n            }\n          });\n        }\n      }\n\n      res.end();\n      return next();\n    });\n\n    server.add(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapadd -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" -f ./user.ldif\n      const cn = req.dn.rdns[0].attrs.cn;\n      if (!req.dn.rdns[0].attrs.cn)\n        return next(new ldap.ConstraintViolationError('cn required'));\n\n      const users = await findUsers({\n        registerInClient: ObjectId(req.currentClientId),\n        isDeleted: false,\n        username: cn.value,\n      });\n\n      if (users && users.length > 0) {\n        return next(new ldap.EntryAlreadyExistsError(req.dn.toString()));\n      }\n\n      try {\n        const authing = new Authing({\n          userPoolId: req.currentClientId,\n          secret: client.secret,\n          host: {\n            user: config.authing.graphqlEndPoint.core,\n            oauth: config.authing.graphqlEndPoint.core,\n          },\n          passwordEncPublicKey: config.authing.passwordEncPublicKey,\n        });\n\n        await authing.register({\n          username: cn.value,\n          nickname: cn.value,\n          unionid: `ldap|${cn.value}`,\n          registerMethod: `ldap:sso::from-ldapadd`,\n        });\n      } catch (error) {\n        return next(new ldap.UnavailableError(error.toString()));\n      }\n\n      res.end();\n      return next();\n    });\n\n    server.del(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapdelete -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" \"cn=ldapjs, ou=users, o=59f86b4832eb28071bdd9214, dc=authing,dc=cn\"\n      const cn = req.dn.rdns[0].attrs.cn;\n      if (!req.dn.rdns[0].attrs.cn)\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n\n      const users = await findUsers({\n        registerInClient: ObjectId(req.currentClientId),\n        isDeleted: false,\n        username: cn.value,\n      });\n\n      if (!users || users.length === 0) {\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n      }\n\n      try {\n        await removeUser({\n          registerInClient: ObjectId(req.currentClientId),\n          username: cn.value,\n        });\n      } catch (error) {\n        return next(new ldap.UnavailableError(error.toString()));\n      }\n\n      res.end();\n      return next();\n    });\n\n    server.modify(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapmodify -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" -f ./modify.ldif\n      const cn: any = req.dn.rdns[0].attrs.cn;\n      if (!req.dn.rdns[0].attrs.cn)\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n\n      if (!req.changes.length)\n        return next(new ldap.ProtocolError('changes required'));\n\n      const users: any = await findUsers({\n        registerInClient: ObjectId(req.currentClientId),\n        isDeleted: false,\n        username: cn.value,\n      });\n\n      if (!users || users.length === 0) {\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n      }\n\n      const user: any = users[0];\n\n      let mod: any, authing: any;\n\n      for (var i = 0; i < req.changes.length; i++) {\n        mod = req.changes[i].modification;\n        switch (req.changes[i].operation) {\n          case 'replace':\n            const typeMapping: any = {\n              userpassword: 'password',\n              mail: 'email',\n              cn: ['username'],\n            };\n            // 不允许修改密码，因为无法提供 oldPassword，日后可以改善下\n            const notAllowedTypes = ['gid', 'uid', '_id', 'userpassword'];\n            if (notAllowedTypes.indexOf(mod.type) > -1) {\n              return next(\n                new ldap.UnwillingToPerformError(\n                  `${mod.type} is not allowed to modify`\n                )\n              );\n            }\n\n            let fieldModified: any = mod.type;\n\n            if (typeMapping[mod.type]) {\n              fieldModified = typeMapping[mod.type];\n            }\n\n            try {\n              authing =\n                authing ||\n                new Authing({\n                  userPoolId: req.currentClientId,\n                  secret: client.secret,\n                  host: {\n                    user: config.authing.graphqlEndPoint.core,\n                    oauth: config.authing.graphqlEndPoint.core,\n                  },\n                  passwordEncPublicKey: config.authing.passwordEncPublicKey,\n                });\n\n              if (\n                fieldModified instanceof String ||\n                typeof fieldModified === 'string'\n              ) {\n                let query: any = {\n                  _id: user._id,\n                };\n                const field: any = fieldModified;\n                query[field] = mod.vals[0];\n                await authing.update(query);\n              } else {\n                let query: any = {\n                  _id: users[0]._id,\n                };\n                for (let i = 0; i < fieldModified.length; i++) {\n                  query[fieldModified[i]] = mod.vals[0];\n                }\n                await authing.update(query);\n              }\n            } catch (error) {\n              return next(new ldap.UnavailableError(JSON.stringify(error)));\n            }\n            break;\n          case 'add':\n            return next(\n              new ldap.UnwillingToPerformError('only replace allowed')\n            );\n          case 'delete':\n            return next(\n              new ldap.UnwillingToPerformError('only replace allowed')\n            );\n        }\n      }\n\n      res.end();\n      return next();\n    });\n  };\n\n  findClients((clients: any) => {\n    for (let i = 0; i < clients.length; i++) {\n      const client = clients[i] || {};\n      initLdapRoutes(client);\n    }\n\n    const collection = db.collection('userpools');\n    const changeStream = collection.watch();\n    changeStream.on('change', (oplog: any) => {\n      // process next document\n      const operationType = oplog.operationType;\n      if (operationType === 'insert') {\n        const client = oplog.fullDocument;\n        console.log('add client to ldap', client);\n        initLdapRoutes(client);\n      }\n    });\n\n    server.listen(1389, function() {\n      console.log('LDAP server up at: %s', server.url);\n    });\n  });\n};\n"],"names":["domainComponent","authing","graphqlEndPoint","core","passwordEncPublicKey","ldap","require","MongoClient","ObjectId","ldapdb","assert","Authing","url","user","password","replicaSet","addr","dbname","name","process","on","err","console","log","generateDc","seperator","arr","map","item","dcStr","join","connect","_err","client","equal","db","createLDAPServer","server","createServer","findUsers","opts","Promise","resolve","reject","collection","find","toArray","docs","findClients","callback","clients","isDeleted","removeUser","query","_resolve","_reject","updateOne","$set","then","users","catch","initLdapRoutes","bindDN","_id","config","SUFFIX","bind","_req","res","next","o","dn","rdns","attrs","currentClientId","value","i","length","rdn","key","toString","dnString","indexOf","uid","registerInClient","userPoolId","secret","host","oauth","loginOpt","username","credentials","login","error","InvalidCredentialsError","JSON","stringify","end","authorize","_res","connection","equals","InsufficientAccessRightsError","loadCurrentClientId","req","pre","search","filterKey","filter","attribute","filterValue","filterKeyMapping","cn","gid","queryOptions","currentUser","send","attributes","Object","keys","forEach","matches","add","ConstraintViolationError","EntryAlreadyExistsError","register","nickname","unionid","registerMethod","UnavailableError","del","NoSuchObjectError","modify","changes","ProtocolError","mod","modification","operation","typeMapping","userpassword","mail","notAllowedTypes","type","UnwillingToPerformError","fieldModified","String","field","vals","update","changeStream","watch","oplog","operationType","fullDocument","listen"],"mappings":"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"}