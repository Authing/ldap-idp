{"version":3,"file":"ldap-idp.cjs.development.js","sources":["../src/index.ts"],"sourcesContent":["const ldap = require('ldapjs');\n\n///--- Shared handlers\n\nfunction authorize(req: { connection: { ldap: { bindDN: { equals: (arg0: string) => string; }; }; }; }, _res: any, next: { (arg0: any): void; (): void; }) {\n  /* Any user may search after bind, only cn=root has full power */\n  var isSearch = (req instanceof ldap.SearchRequest);\n  if (!req.connection.ldap.bindDN.equals('cn=root') && !isSearch)\n    return next(new ldap.InsufficientAccessRightsError());\n\n  return next();\n}\n\n\n///--- Globals\n\nvar SUFFIX: string = 'o=joyent';\nvar db: any = {};\nvar server: any = ldap.createServer();\n\nserver.bind('cn=root', function(req: any, res: any, next: any) {\n  if (req.dn.toString() !== 'cn=root' || req.credentials !== 'secret')\n    return next(new ldap.InvalidCredentialsError());\n\n  res.end();\n  return next();\n});\n\nserver.add(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; toObject: () => { attributes: any; }; }, res: { end: () => void; }, next: { (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n\n  if (db[dn])\n    return next(new ldap.EntryAlreadyExistsError(dn));\n\n  db[dn] = req.toObject().attributes;\n  res.end();\n  return next();\n});\n\nserver.bind(SUFFIX, function(req: { dn: { toString: () => string; }; credentials: any; }, res: { end: () => void; }, next: { (arg0: any): void; (arg0: any): void; (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  if (!db[dn].userpassword)\n    return next(new ldap.NoSuchAttributeError('userPassword'));\n\n  if (db[dn].userpassword.indexOf(req.credentials) === -1)\n    return next(new ldap.InvalidCredentialsError());\n\n  res.end();\n  return next();\n});\n\nserver.compare(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; attribute: string | number; value: any; }, res: { end: (arg0: boolean) => void; }, next: { (arg0: any): void; (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  if (!db[dn][req.attribute])\n    return next(new ldap.NoSuchAttributeError(req.attribute));\n\n  var matches = false;\n  var vals = db[dn][req.attribute];\n  for (var i = 0; i < vals.length; i++) {\n    if (vals[i] === req.value) {\n      matches = true;\n      break;\n    }\n  }\n\n  res.end(matches);\n  return next();\n});\n\nserver.del(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; }, res: { end: () => void; }, next: { (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  delete db[dn];\n\n  res.end();\n  return next();\n});\n\nserver.modify(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; changes: { operation: any, modification: any; }[]; }, res: { end: () => void; }, next: { (arg0: any): void; (arg0: any): void; (arg0: any): void; (arg0: any): void; (): void; }) {\n  const dn = req.dn.toString();\n  let mod: any = null;\n  if (!req.changes.length)\n    return next(new ldap.ProtocolError('changes required'));\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  var entry = db[dn];\n\n  for (var i = 0; i < req.changes.length; i++) {\n    mod = req.changes[i].modification;\n    switch (req.changes[i].operation) {\n    case 'replace':\n      if (!entry[mod.type])\n        return next(new ldap.NoSuchAttributeError(mod.type));\n\n      if (!mod.vals || !mod.vals.length) {\n        delete entry[mod.type];\n      } else {\n        entry[mod.type] = mod.vals;\n      }\n\n      break;\n\n    case 'add':\n      if (!entry[mod.type]) {\n        entry[mod.type] = mod.vals;\n      } else {\n        mod.vals.forEach(function(v: any) {\n          if (entry[mod.type].indexOf(v) === -1)\n            entry[mod.type].push(v);\n        });\n      }\n\n      break;\n\n    case 'delete':\n      if (!entry[mod.type])\n        return next(new ldap.NoSuchAttributeError(mod.type));\n\n      delete entry[mod.type];\n\n      break;\n    }\n  }\n\n  res.end();\n  return next();\n});\n\nserver.search(SUFFIX, authorize, function(req: { dn: { toString: () => string; equals: { (arg0: any): boolean; (arg0: any): boolean; }; parentOf: (arg0: any) => void; }; scope: any; filter: { matches: { (arg0: any): boolean; (arg0: any): boolean; }; }; }, res: { send: { (arg0: { dn: any; attributes: any; }): void; (arg0: { dn: string; attributes: any; }): void; }; end: { (): void; (): void; }; }, next: { (arg0: any): void; (): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  var scopeCheck: { (k: any): any; (k: any): any; (arg0: string): void; };\n\n  switch (req.scope) {\n  case 'base':\n    if (req.filter.matches(db[dn])) {\n      res.send({\n        dn: dn,\n        attributes: db[dn]\n      });\n    }\n\n    res.end();\n    return next();\n\n  case 'one':\n    scopeCheck = function(k: any) {\n      if (req.dn.equals(k))\n        return true;\n\n      var parent = ldap.parseDN(k).parent();\n      return (parent ? parent.equals(req.dn) : false);\n    };\n    break;\n\n  case 'sub':\n    scopeCheck = function(k: any) {\n      return (req.dn.equals(k) || req.dn.parentOf(k));\n    };\n\n    break;\n  }\n\n  Object.keys(db).forEach(function(key) {\n    if (!scopeCheck(key))\n      return;\n\n    if (req.filter.matches(db[key])) {\n      res.send({\n        dn: key,\n        attributes: db[key]\n      });\n    }\n  });\n\n  res.end();\n  return next();\n});\n\n///--- Fire it up\n\nserver.listen(1389, function() {\n  console.log('LDAP server up at: %s', server.url);\n});"],"names":["ldap","require","authorize","req","_res","next","isSearch","SearchRequest","connection","bindDN","equals","InsufficientAccessRightsError","SUFFIX","db","server","createServer","bind","res","dn","toString","credentials","InvalidCredentialsError","end","add","EntryAlreadyExistsError","toObject","attributes","NoSuchObjectError","userpassword","NoSuchAttributeError","indexOf","compare","attribute","matches","vals","i","length","value","del","modify","mod","changes","ProtocolError","entry","modification","operation","type","forEach","v","push","search","scopeCheck","scope","filter","send","k","parent","parseDN","parentOf","Object","keys","key","listen","console","log","url"],"mappings":"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"}