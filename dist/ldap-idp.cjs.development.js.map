{"version":3,"file":"ldap-idp.cjs.development.js","sources":["../src/index.ts"],"sourcesContent":["const ldap = require('ldapjs');\nconst parseDN = require('ldapjs').parseDN;\nconst fs = require('fs');\nconst MongoClient = require('mongodb').MongoClient;\nconst ObjectId = require('mongodb').ObjectId;\nconst ldapdb = require('./ldapdb.json');\n\nconst assert = require('assert');\n\nconst Authing = require('authing-js-sdk');\n\n// Connection URL\nconst url = [\n  'mongodb://',\n  ldapdb.user + ':' + ldapdb.password + '@',\n  ldapdb.ip,\n  ':',\n  ldapdb.port,\n  '/',\n  ldapdb.dbname,\n].join('');\n\n// Use connect method to connect to the server\nMongoClient.connect(url, function(_err: any, client: any) {\n  assert.equal(null, _err);\n\n  console.log('Connected successfully to server');\n\n  const db = client.db(ldapdb.dbname);\n  createLDAPServer(db);\n  // client.close();\n});\n\nconst createLDAPServer = (db: any) => {\n  const server: any = ldap.createServer();\n\n  const findUsers: any = function(opts: any) {\n    return new Promise((resolve: any, reject: any) => {\n      const collection = db.collection('users');\n      opts['isDeleted'] = false;\n      collection.find(opts).toArray(function(err: any, docs: any) {\n        if (err) reject(err);\n        resolve(docs);\n      });\n    });\n  };\n\n  const findClients: any = function(callback: any) {\n    const clients = db.collection('userclients');\n    clients\n      .find({\n        isDeleted: false,\n      })\n      .toArray(function(err: any, docs: any) {\n        assert.equal(err, null);\n        callback(docs);\n      });\n  };\n\n  const removeUser: any = function(query: any) {\n    return new Promise((_resolve: any, _reject: any) => {\n      const collection = db.collection('users');\n      query['isDeleted'] = false;\n      collection.updateOne(query, {\n        $set: {\n          isDeleted: true,\n        },\n      });\n      findUsers(query)\n        .then((users: any) => {\n          _resolve(users);\n        })\n        .catch((err: any) => {\n          _reject(err);\n        });\n    });\n  };\n\n  // const updateUser: any = function(query: any, set: any) {\n  //   return new Promise((_resolve: any, _reject: any) => {\n  //     const collection = db.collection('users');\n  //     query['isDeleted'] = false;\n  //     collection.updateOne(query, set);\n  //     findUsers(query)\n  //       .then((users: any) => {\n  //         _resolve(users);\n  //       })\n  //       .catch((err: any) => {\n  //         _reject(err);\n  //       });\n  //   });\n  // };\n\n  findClients((clients: any) => {\n    const loadCurrentClientId = (req: any, _res: any, next: any) => {\n      req.currentClientId = '';\n      const rdns: any = req.dn.rdns;\n      for (let i = 0; i < rdns.length; i++) {\n        const rdn = rdns[i];\n        for (let key in rdn.attrs) {\n          if (key === 'o') {\n            req.currentClientId = rdn.attrs.o.value;\n          }\n        }\n      }\n      return next();\n    };\n\n    for (let i = 0; i < clients.length; i++) {\n      const client = clients[i];\n\n      let bindDN: string = `ou=users,o=${client._id},dc=authing,dc=cn`;\n      const SUFFIX: string = `o=${client._id}, ou=users, dc=authing, dc=cn`;\n\n      /*\n        DN = uid=LDAP_BINDING_USER（邮箱或者手机号）,ou=Users,o=AUTHING_CLINET_ID,dc=authing,dc=cn\n        ldapsearch -H ldap://localhost:1389 -x -D \"ou=users,o=59f86b4832eb28071bdd9214,dc=authing,dc=cn\" -LLL -b \"o=59f86b4832eb28071bdd9214,ou=users,dc=authing,dc=cn\" cn=18000179176\n      */\n\n      server.bind(bindDN, function(_req: any, res: any, next: any) {\n        // if (req.dn.toString() !== 'cn=root')\n        //   return next(new ldap.InvalidCredentialsError());\n\n        res.end();\n        return next();\n      });\n\n      const authorize = (_req: any, _res: any, next: any) => {\n        if (!_req.connection.ldap.bindDN.equals(bindDN))\n          return next(new ldap.InsufficientAccessRightsError());\n        return next();\n      };\n\n      const pre: any = [authorize, loadCurrentClientId];\n\n      server.search(SUFFIX, pre, async function(req: any, res: any, next: any) {\n        // ldapsearch -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -LLL -b \"o=5c344f102e450b000170190a,ou=users,dc=authing,dc=cn\" cn=ldap-tester\n\n        const filterKey: any = req.filter.attribute;\n        const filterValue: any = req.filter.value || '*';\n\n        const filterKeyMapping: any = {\n          cn: 'username',\n          gid: '_id',\n          uid: '_id',\n        };\n\n        let queryOptions: any = {\n          registerInClient: ObjectId(req.currentClientId),\n        };\n\n        let users: any;\n        req.users = {};\n\n        if (filterKeyMapping[filterKey]) {\n          const key: any = filterKeyMapping[filterKey];\n          queryOptions[key] =\n            key === '_id' ? ObjectId(filterValue) : filterValue;\n          users = await findUsers(queryOptions);\n\n          const currentUser: any = users[0];\n          const cn: any = currentUser.username;\n          const dn: string = `cn=${cn},uid=${\n            currentUser._id\n          }, ou=users, o=${req.currentClientId}, dc=authing, dc=cn`;\n          currentUser['cn'] = cn;\n          currentUser['gid'] = currentUser._id;\n          currentUser['uid'] = currentUser._id;\n          currentUser['objectclass'] = 'users';\n\n          delete currentUser['__v'];\n          delete currentUser['isDeleted'];\n          delete currentUser['salt'];\n  \n          res.send({\n            dn,\n            attributes: currentUser,\n          });           \n        }else {\n          users = await findUsers(queryOptions);\n          for(var i = 0; i < users.length; i++) {\n            const currentUser: any = users[i];\n            const cn: any = currentUser.username;\n            const dn: string = `cn=${cn},uid=${\n              currentUser._id\n            }, ou=users, o=${req.currentClientId}, dc=authing, dc=cn`;\n            currentUser['cn'] = cn;\n            currentUser['gid'] = currentUser._id;\n            currentUser['uid'] = currentUser._id;\n            currentUser['objectclass'] = 'users';\n            delete currentUser['__v'];\n            delete currentUser['isDeleted'];\n            delete currentUser['salt'];\n\n            req.users[currentUser._id] = {\n              dn,\n              attributes: currentUser,\n            };\n\n            let scopeCheck: any;\n\n            switch (req.scope) {\n            case 'base':\n              if (req.filter.matches(db[dn])) {\n                res.send({\n                  dn: dn,\n                  attributes: db[dn]\n                });\n              }\n          \n              res.end();\n              return next();\n          \n            case 'one':\n              scopeCheck = function(k: any) {\n                if (req.dn.equals(k))\n                  return true;\n          \n                var parent = ldap.parseDN(k).parent();\n                return (parent ? parent.equals(req.dn) : false);\n              };\n              break;\n          \n            case 'sub':\n              scopeCheck = function(k: any) {\n                return (req.dn.equals(k) || req.dn.parentOf(k));\n              };\n          \n              break;\n            }\n\n            Object.keys(req.users).forEach(function(key) {\n              if (!scopeCheck(key))\n                return;\n          \n              if (req.filter.matches(req.users[key])) {\n                res.send(req.users[key]);\n              }\n            });\n\n            // console.log(req.users);\n          }\n        }\n\n        res.end();\n        return next();\n      });\n\n      server.add(SUFFIX, pre, async function(req: any, res: any, next: any) {\n        // ldapadd -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -f ./user.ldif\n        const cn = req.dn.rdns[0].attrs.cn;\n        if (!req.dn.rdns[0].attrs.cn)\n          return next(new ldap.ConstraintViolationError('cn required'));\n\n        const users = await findUsers({\n          registerInClient: ObjectId(req.currentClientId),\n          isDeleted: false,\n          username: cn.value,\n        });\n\n        if (users && users.length > 0) {\n          return next(new ldap.EntryAlreadyExistsError(req.dn.toString()));\n        }\n\n        try {\n          const authing = await new Authing({\n            clientId: req.currentClientId,\n            secret: '03bb8b2fca823137c7dec63fd0029fc2',\n          });\n\n          await authing.register({\n            username: cn.value,\n            nickname: cn.value,\n            unionid: `ldap|${cn.value}`,\n            registerMethod: 'sso:ldap-add',\n          });\n        } catch (error) {\n          return next(new ldap.UnavailableError(error.toString()));\n        }\n\n        res.end();\n        return next();\n      });\n\n      server.del(SUFFIX, pre, async function(req: any, res: any, next: any) {\n        // ldapdelete -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" \"cn=ldapjs, o=5c344f102e450b000170190a, ou=users, dc=authing,dc=cn\"\n        const cn = req.dn.rdns[0].attrs.cn;\n        if (!req.dn.rdns[0].attrs.cn)\n          return next(new ldap.NoSuchObjectError(req.dn.toString()));\n\n        const users = await findUsers({\n          registerInClient: ObjectId(req.currentClientId),\n          isDeleted: false,\n          username: cn.value,\n        });\n\n        if (!users || users.length === 0) {\n          return next(new ldap.NoSuchObjectError(req.dn.toString()));\n        }\n\n        try {\n          await removeUser({\n            registerInClient: ObjectId(req.currentClientId),\n            username: cn.value,\n          });\n        } catch (error) {\n          return next(new ldap.UnavailableError(error.toString()));\n        }\n\n        res.end();\n        return next();\n      });\n\n      server.modify(SUFFIX, pre, async function(req: any, res: any, next: any) {\n        // ldapmodify -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -f ./modify.ldif\n        const cn: any = req.dn.rdns[0].attrs.cn;\n        if (!req.dn.rdns[0].attrs.cn)\n          return next(new ldap.NoSuchObjectError(req.dn.toString()));\n\n        if (!req.changes.length)\n          return next(new ldap.ProtocolError('changes required'));\n\n        const users: any = await findUsers({\n          registerInClient: ObjectId(req.currentClientId),\n          isDeleted: false,\n          username: cn.value,\n        });\n\n        if (!users || users.length === 0) {\n          return next(new ldap.NoSuchObjectError(req.dn.toString()));\n        }\n\n        const user: any = users[0];\n\n        let mod: any, authing: any;\n\n        for (var i = 0; i < req.changes.length; i++) {\n          mod = req.changes[i].modification;\n          switch (req.changes[i].operation) {\n            case 'replace':\n              const typeMapping: any = {\n                userpassword: 'password',\n                mail: 'email',\n                cn: ['username'],\n              };\n\n              const notAllowedTypes = ['gid', 'uid', '_id'];\n\n              if (notAllowedTypes.indexOf(mod.type) > -1) {\n                return next(\n                  new ldap.UnwillingToPerformError(\n                    `${mod.type} is not allowed to modify`\n                  )\n                );\n              }\n\n              let fieldModified: any = mod.type;\n\n              if (typeMapping[mod.type]) {\n                fieldModified = typeMapping[mod.type];\n              }\n\n              try {\n                authing =\n                  authing ||\n                  (await new Authing({\n                    clientId: req.currentClientId,\n                    secret: '03bb8b2fca823137c7dec63fd0029fc2',\n                  }));\n\n                if (\n                  fieldModified instanceof String ||\n                  typeof fieldModified === 'string'\n                ) {\n                  let query: any = {\n                    _id: user._id,\n                  };\n                  const field: any = fieldModified;\n                  query[field] = mod.vals[0];\n                  await authing.update(query);\n                } else {\n                  let query: any = {\n                    _id: users[0]._id,\n                  };\n                  for (let i = 0; i < fieldModified.length; i++) {\n                    query[fieldModified[i]] = mod.vals[0];\n                  }\n                  await authing.update(query);\n                }\n              } catch (error) {\n                return next(new ldap.UnavailableError(error.toString()));\n              }\n              break;\n            case 'add':\n              return next(\n                new ldap.UnwillingToPerformError('only replace allowed')\n              );\n            case 'delete':\n              return next(\n                new ldap.UnwillingToPerformError('only replace allowed')\n              );\n          }\n        }\n\n        res.end();\n        return next();\n      });\n    }\n\n    server.listen(1389, function() {\n      console.log('LDAP server up at: %s', server.url);\n    });\n  });\n};\n"],"names":["ldap","require","parseDN","MongoClient","ObjectId","ldapdb","assert","Authing","url","user","password","ip","port","dbname","join","connect","_err","client","equal","console","log","db","createLDAPServer","server","createServer","findUsers","opts","Promise","resolve","reject","collection","find","toArray","err","docs","findClients","callback","clients","isDeleted","removeUser","query","_resolve","_reject","updateOne","$set","then","users","catch","loadCurrentClientId","req","_res","next","currentClientId","rdns","dn","i","length","rdn","key","attrs","o","value","bindDN","_id","SUFFIX","bind","_req","res","end","authorize","connection","equals","InsufficientAccessRightsError","pre","search","filterKey","filter","attribute","filterValue","filterKeyMapping","cn","gid","uid","queryOptions","registerInClient","currentUser","username","send","attributes","scopeCheck","scope","matches","k","parent","parentOf","Object","keys","forEach","add","ConstraintViolationError","EntryAlreadyExistsError","toString","authing","clientId","secret","register","nickname","unionid","registerMethod","error","UnavailableError","del","NoSuchObjectError","modify","changes","ProtocolError","mod","modification","operation","typeMapping","userpassword","mail","notAllowedTypes","indexOf","type","UnwillingToPerformError","fieldModified","String","field","vals","update","listen"],"mappings":"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"}