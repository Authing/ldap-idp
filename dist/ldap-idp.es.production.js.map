{"version":3,"file":"ldap-idp.es.production.js","sources":["../src/index.ts"],"sourcesContent":["const ldap = require('ldapjs');\n\n///--- Shared handlers\n\nfunction authorize(req: { connection: { ldap: { bindDN: { equals: (arg0: string) => string; }; }; }; }, _res: any, next: { (arg0: any): void; (): void; }) {\n  /* Any user may search after bind, only cn=root has full power */\n  var isSearch = (req instanceof ldap.SearchRequest);\n  if (!req.connection.ldap.bindDN.equals('cn=root') && !isSearch)\n    return next(new ldap.InsufficientAccessRightsError());\n\n  return next();\n}\n\n\n///--- Globals\n\nvar SUFFIX: string = 'o=joyent';\nvar db: any = {};\nvar server: any = ldap.createServer();\n\nserver.bind('cn=root', function(req: any, res: any, next: any) {\n  if (req.dn.toString() !== 'cn=root' || req.credentials !== 'secret')\n    return next(new ldap.InvalidCredentialsError());\n\n  res.end();\n  return next();\n});\n\nserver.add(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; toObject: () => { attributes: any; }; }, res: { end: () => void; }, next: { (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n\n  if (db[dn])\n    return next(new ldap.EntryAlreadyExistsError(dn));\n\n  db[dn] = req.toObject().attributes;\n  res.end();\n  return next();\n});\n\nserver.bind(SUFFIX, function(req: { dn: { toString: () => string; }; credentials: any; }, res: { end: () => void; }, next: { (arg0: any): void; (arg0: any): void; (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  if (!db[dn].userpassword)\n    return next(new ldap.NoSuchAttributeError('userPassword'));\n\n  if (db[dn].userpassword.indexOf(req.credentials) === -1)\n    return next(new ldap.InvalidCredentialsError());\n\n  res.end();\n  return next();\n});\n\nserver.compare(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; attribute: string | number; value: any; }, res: { end: (arg0: boolean) => void; }, next: { (arg0: any): void; (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  if (!db[dn][req.attribute])\n    return next(new ldap.NoSuchAttributeError(req.attribute));\n\n  var matches = false;\n  var vals = db[dn][req.attribute];\n  for (var i = 0; i < vals.length; i++) {\n    if (vals[i] === req.value) {\n      matches = true;\n      break;\n    }\n  }\n\n  res.end(matches);\n  return next();\n});\n\nserver.del(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; }, res: { end: () => void; }, next: { (arg0: any): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  delete db[dn];\n\n  res.end();\n  return next();\n});\n\nserver.modify(SUFFIX, authorize, function(req: { dn: { toString: () => string; }; changes: { operation: any, modification: any; }[]; }, res: { end: () => void; }, next: { (arg0: any): void; (arg0: any): void; (arg0: any): void; (arg0: any): void; (): void; }) {\n  const dn = req.dn.toString();\n  let mod: any = null;\n  if (!req.changes.length)\n    return next(new ldap.ProtocolError('changes required'));\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  var entry = db[dn];\n\n  for (var i = 0; i < req.changes.length; i++) {\n    mod = req.changes[i].modification;\n    switch (req.changes[i].operation) {\n    case 'replace':\n      if (!entry[mod.type])\n        return next(new ldap.NoSuchAttributeError(mod.type));\n\n      if (!mod.vals || !mod.vals.length) {\n        delete entry[mod.type];\n      } else {\n        entry[mod.type] = mod.vals;\n      }\n\n      break;\n\n    case 'add':\n      if (!entry[mod.type]) {\n        entry[mod.type] = mod.vals;\n      } else {\n        mod.vals.forEach(function(v: any) {\n          if (entry[mod.type].indexOf(v) === -1)\n            entry[mod.type].push(v);\n        });\n      }\n\n      break;\n\n    case 'delete':\n      if (!entry[mod.type])\n        return next(new ldap.NoSuchAttributeError(mod.type));\n\n      delete entry[mod.type];\n\n      break;\n    }\n  }\n\n  res.end();\n  return next();\n});\n\nserver.search(SUFFIX, authorize, function(req: { dn: { toString: () => string; equals: { (arg0: any): boolean; (arg0: any): boolean; }; parentOf: (arg0: any) => void; }; scope: any; filter: { matches: { (arg0: any): boolean; (arg0: any): boolean; }; }; }, res: { send: { (arg0: { dn: any; attributes: any; }): void; (arg0: { dn: string; attributes: any; }): void; }; end: { (): void; (): void; }; }, next: { (arg0: any): void; (): void; (): void; }) {\n  var dn = req.dn.toString();\n  if (!db[dn])\n    return next(new ldap.NoSuchObjectError(dn));\n\n  var scopeCheck: { (k: any): any; (k: any): any; (arg0: string): void; };\n\n  switch (req.scope) {\n  case 'base':\n    if (req.filter.matches(db[dn])) {\n      res.send({\n        dn: dn,\n        attributes: db[dn]\n      });\n    }\n\n    res.end();\n    return next();\n\n  case 'one':\n    scopeCheck = function(k: any) {\n      if (req.dn.equals(k))\n        return true;\n\n      var parent = ldap.parseDN(k).parent();\n      return (parent ? parent.equals(req.dn) : false);\n    };\n    break;\n\n  case 'sub':\n    scopeCheck = function(k: any) {\n      return (req.dn.equals(k) || req.dn.parentOf(k));\n    };\n\n    break;\n  }\n\n  Object.keys(db).forEach(function(key) {\n    if (!scopeCheck(key))\n      return;\n\n    if (req.filter.matches(db[key])) {\n      res.send({\n        dn: key,\n        attributes: db[key]\n      });\n    }\n  });\n\n  res.end();\n  return next();\n});\n\n///--- Fire it up\n\nserver.listen(1389, function() {\n  console.log('LDAP server up at: %s', server.url);\n});"],"names":["ldap","require","authorize","req","_res","next","isSearch","SearchRequest","connection","bindDN","equals","InsufficientAccessRightsError","SUFFIX","db","server","createServer","bind","res","dn","toString","credentials","InvalidCredentialsError","end","add","EntryAlreadyExistsError","toObject","attributes","userpassword","indexOf","NoSuchAttributeError","NoSuchObjectError","compare","attribute","matches","vals","i","length","value","del","modify","mod","changes","ProtocolError","entry","modification","operation","type","forEach","v","push","search","scopeCheck","scope","filter","send","k","parent","parseDN","parentOf","Object","keys","key","listen","console","log","url"],"mappings":"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"}