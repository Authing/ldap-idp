{"version":3,"file":"ldap-idp.umd.development.js","sources":["../src/index.ts"],"sourcesContent":["const ldap = require('ldapjs');\nconst parseDN = require('ldapjs').parseDN;\nconst fs = require('fs');\nconst MongoClient = require('mongodb').MongoClient;\nconst ObjectId = require('mongodb').ObjectId;\nconst ldapdb = require('./ldapdb.json');\n\nconst assert = require('assert');\n\n// Connection URL\nconst url = [\n  'mongodb://',\n  ldapdb.user + ':' + ldapdb.password + '@',\n  ldapdb.ip,\n  ':',\n  ldapdb.port,\n  '/',\n  ldapdb.dbname,\n].join('');\n\n// Use connect method to connect to the server\nMongoClient.connect(url, function(_err: any, client: any) {\n  assert.equal(null, _err);\n  console.log('Connected successfully to server');\n  const db = client.db(ldapdb.dbname);\n\n  createLDAPServer(db);\n\n  // const insertDocuments = function(db, callback) {\n  //   // Get the documents collection\n  //   const collection = db.collection('documents');\n  //   // Insert some documents\n  //   collection.insertMany([\n  //     {a : 1}, {a : 2}, {a : 3}\n  //   ], function(err, result) {\n  //     assert.equal(err, null);\n  //     assert.equal(3, result.result.n);\n  //     assert.equal(3, result.ops.length);\n  //     console.log(\"Inserted 3 documents into the collection\");\n  //     callback(result);\n  //   });\n  // }\n\n  // client.close();\n});\n\nconst createLDAPServer = (db: any) => {\n  const server: any = ldap.createServer();\n\n  const findUsers: any = function(opts: any) {\n    return new Promise((resolve, reject) => {\n      const collection = db.collection('users');\n      opts['isDeleted'] = false;\n      collection.find(opts).toArray(function(err: any, docs: any) {\n        // assert.equal(err, null);\n        if (err) reject(err)\n        // callback(docs);\n        resolve(docs)\n      });  \n    })\n  };\n\n  const findClients: any = function(callback: any) {\n    const clients = db.collection('userclients');\n    clients\n      .find({\n        isDeleted: false,\n      })\n      .toArray(function(err: any, docs: any) {\n        assert.equal(err, null);\n        callback(docs);\n      });\n  };\n\n  findClients((clients: any) => {\n    const loadAuthingUsers = (req: any, _res: any, next: any) => {\n      req.currentClientId = '';\n      const rdns: any = req.dn.rdns;\n      for (let i = 0; i < rdns.length; i++) {\n        const rdn = rdns[i];\n        for (let key in rdn.attrs) {\n          if (key === 'o') {\n            req.currentClientId = rdn.attrs.o.value;\n          }\n        }\n      }\n      return next();\n    };\n\n    for (let i = 0; i < clients.length; i++) {\n      const client = clients[i];\n      const SUFFIX: string = `o=${client._id}, ou=users, dc=authing, dc=cn`;\n\n      let bindDN: string = `ou=users,o=${client._id},dc=authing,dc=cn`;\n\n      /*\n        DN = uid=LDAP_BINDING_USER（邮箱或者手机号）,ou=Users,o=AUTHING_CLINET_ID,dc=authing,dc=cn\n        ldapsearch -H ldap://localhost:1389 -x -D cn=root -LLL -b \"o=authingId,ou=users,dc=authing,dc=cn\" cn=root\n      */\n\n      server.bind(bindDN, function(_req: any, res: any, next: any) {\n        // if (req.dn.toString() !== 'cn=root')\n        //   return next(new ldap.InvalidCredentialsError());\n\n        res.end();\n        return next();\n      });\n\n      const authorize = (_req: any, _res: any, next: any) => {\n        if (!_req.connection.ldap.bindDN.equals(bindDN))\n          return next(new ldap.InsufficientAccessRightsError());\n        return next();\n      };\n\n      const pre: any = [authorize, loadAuthingUsers];\n\n      server.search(SUFFIX, pre, async function(req: any, res: any, next: any) {\n\n        const filterKey: any = req.filter.attribute;\n        const filterValue: any = req.filter.value;\n\n        const filterKeyMapping: any = {\n          cn: ['username', 'email', 'phone', 'unionid'],\n          gid: ['_id'],\n          uid: ['_id'],\n        }\n\n        let queryOptions: any = {\n          registerInClient: ObjectId(req.currentClientId),\n        }\n\n        if (filterKeyMapping[filterKey]) {\n          const filterMapping: any = filterKeyMapping[filterKey];\n          for(let i = 0; i < filterMapping.length; i++) {\n            const key = filterMapping[i];\n            queryOptions[key] = key === '_id' ? ObjectId(filterValue) : filterValue;\n\n            const users: object[] = await findUsers(queryOptions);\n    \n            if (users && users.length > 0) {\n              const currentUser: any = users[0];\n              const cn = currentUser.username ||\n                currentUser.email ||\n                currentUser.phone ||\n                currentUser.unionid;\n              const dn = `cn=${cn},uid=${\n                currentUser._id\n              }, ou=users, o=${req.currentClientId}, dc=authing, dc=cn`; \n              currentUser['cn'] = cn;\n              currentUser['gid'] = currentUser._id;\n              currentUser['uid'] = currentUser._id;\n    \n              delete currentUser['__v'];\n    \n              res.send({\n                dn,\n                attributes: currentUser,\n              });\n              break;\n            }\n\n            delete queryOptions[key];\n          }\n        }\n\n        res.end();\n        return next();\n      });\n    }\n\n    server.listen(1389, function() {\n      console.log('LDAP server up at: %s', server.url);\n    });\n  });\n};\n"],"names":["ldap","require","parseDN","MongoClient","ObjectId","ldapdb","assert","url","user","password","ip","port","dbname","join","connect","_err","client","equal","console","log","db","createLDAPServer","server","createServer","findUsers","opts","Promise","resolve","reject","collection","find","toArray","err","docs","findClients","callback","clients","isDeleted","loadAuthingUsers","req","_res","next","currentClientId","rdns","dn","i","length","rdn","key","attrs","o","value","SUFFIX","_id","bindDN","bind","_req","res","end","authorize","connection","equals","InsufficientAccessRightsError","pre","search","filterKey","filter","attribute","filterValue","filterKeyMapping","cn","gid","uid","queryOptions","registerInClient","filterMapping","users","currentUser","username","email","phone","unionid","send","attributes","listen"],"mappings":"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"}