{"version":3,"file":"ldap-idp.umd.development.js","sources":["../src/config.ts","../src/index.ts"],"sourcesContent":["export default {\n  domainComponent: ['authing', 'cn'],\n  authing: {\n    graphqlEndPoint: {\n      core: 'https://core.authing.cn/graphql',\n    },\n    passwordEncPublicKey: `-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC4xKeUgQ+Aoz7TLfAfs9+paePb\n5KIofVthEopwrXFkp8OCeocaTHt9ICjTT2QeJh6cZaDaArfZ873GPUn00eOIZ7Ae\n+TiA2BKHbCvloW3w5Lnqm70iSsUi5Fmu9/2+68GZRH9L7Mlh8cFksCicW2Y2W2uM\nGKl64GDcIq3au+aqJQIDAQAB\n-----END PUBLIC KEY-----`,\n  },\n};\n","const ldap = require('ldapjs');\n// const parseDN = require('ldapjs').parseDN;\n// const fs = require('fs');\nconst MongoClient = require('mongodb').MongoClient;\nconst ObjectId = require('mongodb').ObjectId;\nconst ldapdb = require('./ldapdb.json');\nimport config from './config';\n\nconst assert = require('assert');\n\nconst Authing = require('authing-js-sdk');\n\n// Connection URL\nconst url = `mongodb://${ldapdb.user}:${ldapdb.password}@${\n  ldapdb.replicaSet.addr\n}/${ldapdb.dbname}?readPreference=secondaryPreferred&replicaSet=${\n  ldapdb.replicaSet.name\n}`;\n\nprocess.on('unhandledRejection', err => {\n  console.log('全局reject');\n  console.log(err);\n});\nfunction generateDc(domainComponent: Array<string>, seperator: string = ',') {\n  let arr = domainComponent.map(item => 'dc=' + item);\n  let dcStr = arr.join(seperator);\n  return dcStr;\n}\n// uncaughtException 避免程序崩溃\nprocess.on('uncaughtException', function(err) {\n  console.log(err);\n});\n\n// Use connect method to connect to the server\nMongoClient.connect(url, function(_err: any, client: any) {\n  assert.equal(null, _err);\n\n  console.log('Connected successfully to server');\n\n  const db = client.db(ldapdb.dbname);\n  createLDAPServer(db);\n  // client.close();\n});\n\nconst createLDAPServer = (db: any) => {\n  const server: any = ldap.createServer();\n\n  const findUsers: any = function(opts: any) {\n    return new Promise((resolve: any, reject: any) => {\n      const collection = db.collection('users');\n      opts['isDeleted'] = false;\n      collection.find(opts).toArray(function(err: any, docs: any) {\n        if (err) reject(err);\n        resolve(docs);\n      });\n    });\n  };\n\n  const findClients: any = function(callback: any) {\n    const clients = db.collection('userpools');\n    clients\n      .find({\n        isDeleted: false,\n      })\n      .toArray(function(err: any, docs: any) {\n        assert.equal(err, null);\n        callback(docs);\n      });\n  };\n\n  const removeUser: any = function(query: any) {\n    return new Promise((_resolve: any, _reject: any) => {\n      const collection = db.collection('users');\n      query['isDeleted'] = false;\n      collection.updateOne(query, {\n        $set: {\n          isDeleted: true,\n        },\n      });\n      findUsers(query)\n        .then((users: any) => {\n          _resolve(users);\n        })\n        .catch((err: any) => {\n          _reject(err);\n        });\n    });\n  };\n\n  // const updateUser: any = function(query: any, set: any) {\n  //   return new Promise((_resolve: any, _reject: any) => {\n  //     const collection = db.collection('users');\n  //     query['isDeleted'] = false;\n  //     collection.updateOne(query, set);\n  //     findUsers(query)\n  //       .then((users: any) => {\n  //         _resolve(users);\n  //       })\n  //       .catch((err: any) => {\n  //         _reject(err);\n  //       });\n  //   });\n  // };\n\n  const initLdapRoutes: any = function(client: any) {\n    let bindDN: string = `ou=users,o=${client._id},${generateDc(\n      config.domainComponent\n    )}`;\n    const SUFFIX: string = `ou=users, o=${client._id}, ${generateDc(\n      config.domainComponent,\n      ', '\n    )}`;\n\n    /*\n      DN = uid=LDAP_BINDING_USER（邮箱或者手机号）,ou=Users,o=AUTHING_CLINET_ID,dc=authing,dc=cn\n      ldapsearch -H ldap://localhost:1389 -x -D \"ou=users,o=59f86b4832eb28071bdd9214,dc=authing,dc=cn\" -LLL -b \"ou=users,o=59f86b4832eb28071bdd9214,dc=authing,dc=cn\" cn=18000179176\n    */\n\n    server.bind(bindDN, async function(_req: any, res: any, next: any) {\n      const o: any = _req.dn.rdns[1].attrs;\n      let currentClientId: any = '';\n      if (o['o']) {\n        currentClientId = o.o.value;\n      } else {\n        const rdns: any = _req.dn.rdns;\n        for (let i = 0; i < rdns.length; i++) {\n          const rdn = rdns[i];\n          for (let key in rdn.attrs) {\n            if (key === 'o') {\n              currentClientId = rdn.attrs.o.value;\n            }\n          }\n        }\n      }\n\n      console.log(_req.dn.rdns.toString());\n\n      const dnString = _req.dn.rdns.toString();\n\n      /*\n        需要分两种类型进行验证\n        1. 只用 client 进行查询，使用 secret 进行验证\n        2. 对单个用户进行查询，使用用户真实密码进行验证\n      */\n\n      if (dnString.indexOf('uid=') > -1) {\n        try {\n          const rdns: any = _req.dn.rdns;\n          let uid: string = '';\n          for (let i = 0; i < rdns.length; i++) {\n            const rdn = rdns[i];\n            for (let key in rdn.attrs) {\n              if (key === 'uid') {\n                uid = rdn.attrs.uid.value;\n              }\n            }\n          }\n\n          const users: any = await findUsers({\n            registerInClient: ObjectId(currentClientId),\n            _id: ObjectId(uid),\n          });\n\n          const user: any = users[0];\n\n          if (user.password) {\n            if (currentClientId.toString() === client._id.toString()) {\n              const authing = new Authing({\n                userPoolId: currentClientId,\n                secret: client.secret,\n                host: {\n                  user: config.authing.graphqlEndPoint.core,\n                  oauth: config.authing.graphqlEndPoint.core,\n                },\n                passwordEncPublicKey: config.authing.passwordEncPublicKey,\n              });\n\n              const loginOpt = {\n                username: user.username,\n                password: _req.credentials,\n              };\n              await authing.login(loginOpt);\n            }\n          }\n        } catch (error) {\n          return next(new ldap.InvalidCredentialsError(JSON.stringify(error)));\n        }\n      } else {\n        if (\n          !(\n            currentClientId.toString() === client._id.toString() &&\n            _req.credentials.toString() === client.secret.toString()\n          )\n        ) {\n          return next(new ldap.InvalidCredentialsError());\n        }\n      }\n\n      res.end();\n      return next();\n    });\n\n    const authorize = (_req: any, _res: any, next: any) => {\n      if (!_req.connection.ldap.bindDN.equals(bindDN))\n        return next(new ldap.InsufficientAccessRightsError());\n      return next();\n    };\n\n    const loadCurrentClientId = (req: any, _res: any, next: any) => {\n      req.currentClientId = '';\n      const rdns: any = req.dn.rdns;\n      for (let i = 0; i < rdns.length; i++) {\n        const rdn = rdns[i];\n        for (let key in rdn.attrs) {\n          if (key === 'o') {\n            req.currentClientId = rdn.attrs.o.value;\n          }\n        }\n      }\n      return next();\n    };\n\n    const pre: any = [authorize, loadCurrentClientId];\n\n    server.search(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapsearch -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" -LLL -b \"ou=users,o=59f86b4832eb28071bdd9214,dc=authing,dc=cn\" cn=ldap-tester\n\n      const filterKey: any = req.filter.attribute;\n      const filterValue: any = req.filter.value || '*';\n\n      // const queryDN = req.dn.toString();\n\n      const filterKeyMapping: any = {\n        cn: 'username',\n        gid: '_id',\n        uid: '_id',\n      };\n\n      let queryOptions: any = {\n        registerInClient: ObjectId(req.currentClientId),\n      };\n\n      let users: any;\n      req.users = {};\n\n      if (filterKeyMapping[filterKey]) {\n        const key: any = filterKeyMapping[filterKey];\n        queryOptions[key] = key === '_id' ? ObjectId(filterValue) : filterValue;\n        users = await findUsers(queryOptions);\n\n        const currentUser: any = users[0];\n        const cn: any = currentUser.username;\n        const dn: string = `cn=${cn},uid=${currentUser._id}, ou=users, o=${\n          req.currentClientId\n        }, ${generateDc(config.domainComponent, ', ')}`;\n        currentUser['cn'] = cn;\n        currentUser['gid'] = currentUser._id;\n        currentUser['uid'] = currentUser._id;\n        currentUser['objectclass'] = 'users';\n\n        delete currentUser['__v'];\n        delete currentUser['isDeleted'];\n        delete currentUser['salt'];\n\n        res.send({\n          dn,\n          attributes: currentUser,\n        });\n      } else {\n        users = await findUsers(queryOptions);\n        for (var i = 0; i < users.length; i++) {\n          const currentUser: any = users[i];\n          const cn: any = currentUser.username;\n          const dn: string = `cn=${cn},uid=${currentUser._id}, ou=users, o=${\n            req.currentClientId\n          }, ${generateDc(config.domainComponent, ', ')}`;\n          currentUser['cn'] = cn;\n          currentUser['gid'] = currentUser._id;\n          currentUser['uid'] = currentUser._id;\n          currentUser['objectclass'] = 'users';\n          delete currentUser['__v'];\n          delete currentUser['isDeleted'];\n          delete currentUser['salt'];\n\n          req.users[dn] = {\n            dn,\n            attributes: currentUser,\n          };\n\n          Object.keys(req.users).forEach(function(key) {\n            if (req.filter.matches(req.users[key].attributes)) {\n              res.send(req.users[key]);\n            }\n          });\n        }\n      }\n\n      res.end();\n      return next();\n    });\n\n    server.add(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapadd -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" -f ./user.ldif\n      const cn = req.dn.rdns[0].attrs.cn;\n      if (!req.dn.rdns[0].attrs.cn)\n        return next(new ldap.ConstraintViolationError('cn required'));\n\n      const users = await findUsers({\n        registerInClient: ObjectId(req.currentClientId),\n        isDeleted: false,\n        username: cn.value,\n      });\n\n      if (users && users.length > 0) {\n        return next(new ldap.EntryAlreadyExistsError(req.dn.toString()));\n      }\n\n      try {\n        const authing = new Authing({\n          userPoolId: req.currentClientId,\n          secret: client.secret,\n          host: {\n            user: config.authing.graphqlEndPoint.core,\n            oauth: config.authing.graphqlEndPoint.core,\n          },\n          passwordEncPublicKey: config.authing.passwordEncPublicKey,\n        });\n\n        await authing.register({\n          username: cn.value,\n          nickname: cn.value,\n          unionid: `ldap|${cn.value}`,\n          registerMethod: `ldap:sso::from-ldapadd`,\n        });\n      } catch (error) {\n        return next(new ldap.UnavailableError(error.toString()));\n      }\n\n      res.end();\n      return next();\n    });\n\n    server.del(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapdelete -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" \"cn=ldapjs, ou=users, o=59f86b4832eb28071bdd9214, dc=authing,dc=cn\"\n      const cn = req.dn.rdns[0].attrs.cn;\n      if (!req.dn.rdns[0].attrs.cn)\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n\n      const users = await findUsers({\n        registerInClient: ObjectId(req.currentClientId),\n        isDeleted: false,\n        username: cn.value,\n      });\n\n      if (!users || users.length === 0) {\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n      }\n\n      try {\n        await removeUser({\n          registerInClient: ObjectId(req.currentClientId),\n          username: cn.value,\n        });\n      } catch (error) {\n        return next(new ldap.UnavailableError(error.toString()));\n      }\n\n      res.end();\n      return next();\n    });\n\n    server.modify(SUFFIX, pre, async function(req: any, res: any, next: any) {\n      // ldapmodify -H ldap://localhost:1389 -x -D \"ou=users,o=5c344f102e450b000170190a,dc=authing,dc=cn\" -w \"03bb8b2fca823137c7dec63fd0029fc2\" -f ./modify.ldif\n      const cn: any = req.dn.rdns[0].attrs.cn;\n      if (!req.dn.rdns[0].attrs.cn)\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n\n      if (!req.changes.length)\n        return next(new ldap.ProtocolError('changes required'));\n\n      const users: any = await findUsers({\n        registerInClient: ObjectId(req.currentClientId),\n        isDeleted: false,\n        username: cn.value,\n      });\n\n      if (!users || users.length === 0) {\n        return next(new ldap.NoSuchObjectError(req.dn.toString()));\n      }\n\n      const user: any = users[0];\n\n      let mod: any, authing: any;\n\n      for (var i = 0; i < req.changes.length; i++) {\n        mod = req.changes[i].modification;\n        switch (req.changes[i].operation) {\n          case 'replace':\n            const typeMapping: any = {\n              userpassword: 'password',\n              mail: 'email',\n              cn: ['username'],\n            };\n            // 不允许修改密码，因为无法提供 oldPassword，日后可以改善下\n            const notAllowedTypes = ['gid', 'uid', '_id', 'userpassword'];\n            if (notAllowedTypes.indexOf(mod.type) > -1) {\n              return next(\n                new ldap.UnwillingToPerformError(\n                  `${mod.type} is not allowed to modify`\n                )\n              );\n            }\n\n            let fieldModified: any = mod.type;\n\n            if (typeMapping[mod.type]) {\n              fieldModified = typeMapping[mod.type];\n            }\n\n            try {\n              authing =\n                authing ||\n                new Authing({\n                  userPoolId: req.currentClientId,\n                  secret: client.secret,\n                  host: {\n                    user: config.authing.graphqlEndPoint.core,\n                    oauth: config.authing.graphqlEndPoint.core,\n                  },\n                  passwordEncPublicKey: config.authing.passwordEncPublicKey,\n                });\n\n              if (\n                fieldModified instanceof String ||\n                typeof fieldModified === 'string'\n              ) {\n                let query: any = {\n                  _id: user._id,\n                };\n                const field: any = fieldModified;\n                query[field] = mod.vals[0];\n                await authing.update(query);\n              } else {\n                let query: any = {\n                  _id: users[0]._id,\n                };\n                for (let i = 0; i < fieldModified.length; i++) {\n                  query[fieldModified[i]] = mod.vals[0];\n                }\n                await authing.update(query);\n              }\n            } catch (error) {\n              return next(new ldap.UnavailableError(JSON.stringify(error)));\n            }\n            break;\n          case 'add':\n            return next(\n              new ldap.UnwillingToPerformError('only replace allowed')\n            );\n          case 'delete':\n            return next(\n              new ldap.UnwillingToPerformError('only replace allowed')\n            );\n        }\n      }\n\n      res.end();\n      return next();\n    });\n  };\n\n  findClients((clients: any) => {\n    for (let i = 0; i < clients.length; i++) {\n      const client = clients[i] || {};\n      initLdapRoutes(client);\n    }\n\n    const collection = db.collection('userpools');\n    const changeStream = collection.watch();\n    changeStream.on('change', (oplog: any) => {\n      // process next document\n      const operationType = oplog.operationType;\n      if (operationType === 'insert') {\n        const client = oplog.fullDocument;\n        console.log('add client to ldap', client);\n        initLdapRoutes(client);\n      }\n    });\n\n    server.listen(1389, function() {\n      console.log('LDAP server up at: %s', server.url);\n    });\n  });\n};\n"],"names":["domainComponent","authing","graphqlEndPoint","core","passwordEncPublicKey","ldap","require","MongoClient","ObjectId","ldapdb","assert","Authing","url","user","password","replicaSet","addr","dbname","name","process","on","err","console","log","generateDc","seperator","arr","map","item","dcStr","join","connect","_err","client","equal","db","createLDAPServer","server","createServer","findUsers","opts","Promise","resolve","reject","collection","find","toArray","docs","findClients","callback","clients","isDeleted","removeUser","query","_resolve","_reject","updateOne","$set","then","users","catch","initLdapRoutes","bindDN","_id","config","SUFFIX","bind","_req","res","next","o","dn","rdns","attrs","currentClientId","value","i","length","rdn","key","toString","dnString","indexOf","uid","registerInClient","userPoolId","secret","host","oauth","loginOpt","username","credentials","login","error","InvalidCredentialsError","JSON","stringify","end","authorize","_res","connection","equals","InsufficientAccessRightsError","loadCurrentClientId","req","pre","search","filterKey","filter","attribute","filterValue","filterKeyMapping","cn","gid","queryOptions","currentUser","send","attributes","Object","keys","forEach","matches","add","ConstraintViolationError","EntryAlreadyExistsError","register","nickname","unionid","registerMethod","UnavailableError","del","NoSuchObjectError","modify","changes","ProtocolError","mod","modification","operation","typeMapping","userpassword","mail","notAllowedTypes","type","UnwillingToPerformError","fieldModified","String","field","vals","update","changeStream","watch","oplog","operationType","fullDocument","listen"],"mappings":"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"}