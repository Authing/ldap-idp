{"version":3,"file":"ldap-idp.umd.development.js","sources":["../src/index.ts"],"sourcesContent":["const ldap = require('ldapjs');\nconst parseDN = require('ldapjs').parseDN;\nconst fs = require('fs');\nconst MongoClient = require('mongodb').MongoClient;\nconst ObjectId = require('mongodb').ObjectId;\nconst ldapdb = require('./ldapdb.json');\n\nconst assert = require('assert');\n\n// Connection URL\nconst url = [\n  'mongodb://',\n  ldapdb.user + ':' + ldapdb.password + '@',\n  ldapdb.ip,\n  ':',\n  ldapdb.port,\n  '/',\n  ldapdb.dbname,\n].join('');\n\n// Use connect method to connect to the server\nMongoClient.connect(url, function(_err: any, client: any) {\n  assert.equal(null, _err);\n  console.log('Connected successfully to server');\n  const db = client.db(ldapdb.dbname);\n\n  createLDAPServer(db);\n\n  // const insertDocuments = function(db, callback) {\n  //   // Get the documents collection\n  //   const collection = db.collection('documents');\n  //   // Insert some documents\n  //   collection.insertMany([\n  //     {a : 1}, {a : 2}, {a : 3}\n  //   ], function(err, result) {\n  //     assert.equal(err, null);\n  //     assert.equal(3, result.result.n);\n  //     assert.equal(3, result.ops.length);\n  //     console.log(\"Inserted 3 documents into the collection\");\n  //     callback(result);\n  //   });\n  // }\n\n  // client.close();\n});\n\nconst createLDAPServer = (db: any) => {\n  const server: any = ldap.createServer();\n\n  const findUsers: any = function(callback: any, opts: any) {\n    const collection = db.collection('users');\n    opts['isDeleted'] = false;\n    collection.find(opts).toArray(function(err: any, docs: any) {\n      assert.equal(err, null);\n      callback(docs);\n    });\n  };\n\n  const findClients: any = function(callback: any) {\n    const clients = db.collection('userclients');\n    clients.find({\n      isDeleted: false,\n    }).toArray(function(err: any, docs: any) {\n      assert.equal(err, null);\n      callback(docs);\n    });\n  }\n\n  findClients((clients: any) => {\n  \n    const loadAuthingUsers = (req: any, _res: any, next: any) => {\n      let currentClientId: string = '';\n      const rdns: any = req.dn.rdns;\n      for (let i = 0; i < rdns.length; i++) {\n        const rdn = rdns[i];\n        for(let key in rdn.attrs) {\n          if (key === 'o') {\n            currentClientId = rdn.attrs.o.value;\n          }\n        }\n      }\n\n      findUsers((users: any) => {\n        req.users = {};  \n        for (var i = 0; i < users.length; i++) {\n          const currentUser: any = users[i];\n          req.users[currentUser._id] = {\n            dn: `cn=${currentUser.username ||\n              currentUser.email ||\n              currentUser.phone ||\n              currentUser.unionid},uid=${\n              currentUser._id\n            }, ou=users, o=${currentClientId}, dc=authing, dc=cn`,\n            attributes: {\n              cn:\n                currentUser.username ||\n                currentUser.email ||\n                currentUser.phone ||\n                currentUser.unionid,\n              uid: currentUser._id,\n              gid: currentUser._id,\n              unionid: currentUser.unionid,\n              email: currentUser.email,\n              phone: currentUser.phone,\n              nickname: currentUser.nickname,\n              username: currentUser.username,\n              photo: currentUser.photo,\n              emailVerified: currentUser.emailVerified,\n              oauth: currentUser.oauth,\n              token: currentUser.token,\n              registerInClient: currentUser.registerInClient,\n              loginsCount: currentUser.loginsCount,\n              lastIP: currentUser.lastIP,\n              company: currentUser.company,\n              objectclass: 'authingUser',\n            },\n          };\n        }\n  \n        return next();\n      }, {\n        registerInClient: ObjectId(currentClientId)\n      });\n    }    \n\n    for(let i = 0; i < clients.length; i++) {\n      const client = clients[i];\n      const SUFFIX: string = `o=${client._id}, ou=users, dc=authing, dc=cn`;\n\n      let bindDN: string = `ou=users,o=${client._id},dc=authing,dc=cn`;\n\n      /*\n        DN = uid=LDAP_BINDING_USER（邮箱或者手机号）,ou=Users,o=AUTHING_CLINET_ID,dc=authing,dc=cn\n        ldapsearch -H ldap://localhost:1389 -x -D cn=root -LLL -b \"o=authingId,ou=users,dc=authing,dc=cn\" cn=root\n      */\n    \n      server.bind(bindDN, function(_req: any, res: any, next: any) {\n        // if (req.dn.toString() !== 'cn=root')\n        //   return next(new ldap.InvalidCredentialsError());\n    \n        res.end();\n        return next();\n      });\n\n      const authorize = (_req: any, _res: any, next: any) => {\n        if (!_req.connection.ldap.bindDN.equals(bindDN))\n          return next(new ldap.InsufficientAccessRightsError());\n        return next();\n      }\n    \n      const pre: any = [authorize, loadAuthingUsers];\n    \n      server.search(SUFFIX, pre, function(req: any, res: any, next: any) {\n        Object.keys(req.users).forEach(function(k) {\n          if (req.filter.matches(req.users[k].attributes)) res.send(req.users[k]);\n        });\n    \n        res.end();\n        return next();\n      });\n    }\n  \n    server.listen(1389, function() {\n      console.log('LDAP server up at: %s', server.url);\n    });\n  });\n};\n"],"names":["ldap","require","parseDN","MongoClient","ObjectId","ldapdb","assert","url","user","password","ip","port","dbname","join","connect","_err","client","equal","console","log","db","createLDAPServer","server","createServer","findUsers","callback","opts","collection","find","toArray","err","docs","findClients","clients","isDeleted","loadAuthingUsers","req","_res","next","currentClientId","rdns","dn","i","length","rdn","key","attrs","o","value","users","currentUser","_id","username","email","phone","unionid","attributes","cn","uid","gid","nickname","photo","emailVerified","oauth","token","registerInClient","loginsCount","lastIP","company","objectclass","SUFFIX","bindDN","bind","_req","res","end","authorize","connection","equals","InsufficientAccessRightsError","pre","search","Object","keys","forEach","k","filter","matches","send","listen"],"mappings":"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"}